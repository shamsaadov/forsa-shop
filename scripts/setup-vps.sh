#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ VPS Ð´Ð»Ñ Forsa Shop
# Ð—Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð¿Ð¾Ð´ root: bash setup-vps.sh

echo "ðŸš€ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° VPS Ð´Ð»Ñ Forsa Shop..."

# ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ
echo "ðŸ“¦ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹..."
apt update && apt upgrade -y

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð¿Ð°ÐºÐµÑ‚Ñ‹
echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð±Ð°Ð·Ð¾Ð²Ñ‹Ñ… Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²..."
apt install -y curl wget git htop nano ufw

# ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ firewall
echo "ðŸ”¥ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° firewall..."
ufw --force enable
ufw allow ssh
ufw allow 80
ufw allow 443

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Docker
echo "ðŸ³ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker..."
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh
rm get-docker.sh

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Docker Compose
echo "ðŸ³ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Docker Compose..."
curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹..."
mkdir -p /var/www
cd /var/www

# Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ SSH ÐºÐ»ÑŽÑ‡ Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ
echo "ðŸ”‘ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ SSH ÐºÐ»ÑŽÑ‡Ð°..."
ssh-keygen -t rsa -b 4096 -C "deploy@forsa-shop" -f ~/.ssh/id_rsa -N ""
cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
chmod 700 ~/.ssh

# ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÑƒÑŽ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÑƒ Docker
echo "ðŸ§¹ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸ Docker..."
cat > /etc/cron.daily/docker-cleanup << 'EOF'
#!/bin/bash
# ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð½ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ñ… Docker Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²
docker system prune -f
docker volume prune -f
EOF
chmod +x /etc/cron.daily/docker-cleanup

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ systemd ÑÐµÑ€Ð²Ð¸Ñ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿ÑƒÑÐºÐ°
echo "âš™ï¸ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd ÑÐµÑ€Ð²Ð¸ÑÐ°..."
cat > /etc/systemd/system/forsa-shop.service << 'EOF'
[Unit]
Description=Forsa Shop
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
RemainAfterExit=true
WorkingDirectory=/var/www/forsa-shop
ExecStart=/usr/local/bin/docker-compose -f docker-compose.yml up -d
ExecStop=/usr/local/bin/docker-compose -f docker-compose.yml down
TimeoutStartSec=0

[Install]
WantedBy=multi-user.target
EOF

systemctl enable forsa-shop.service

echo "âœ… ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° VPS Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
echo ""
echo "ðŸ“‹ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:"
echo "1. Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ð¹ SSH ÐºÐ»ÑŽÑ‡ Ð² GitHub Secrets:"
echo "   cat ~/.ssh/id_rsa"
echo ""
echo "2. Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ ÑÐµÐºÑ€ÐµÑ‚ VPS_SSH_KEY Ð² GitHub:"
echo "   GitHub â†’ Settings â†’ Secrets and variables â†’ Actions"
echo ""
echo "3. Ð—Ð°Ð¼ÐµÐ½Ð¸Ñ‚Ðµ URL Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ Ð² GitHub Action Ð½Ð° Ð²Ð°Ñˆ"
echo ""
echo "4. Ð¡Ð´ÐµÐ»Ð°Ð¹Ñ‚Ðµ push Ð² main Ð²ÐµÑ‚ÐºÑƒ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ñ"
echo ""
echo "ðŸŽ‰ Ð“Ð¾Ñ‚Ð¾Ð²Ð¾! VPS Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ." 