name: Deploy to Production Server

on:
  push:
    branches: [main]
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies and build frontend
        run: |
          npm install
          npm run build

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            set -e
            echo "üöÄ Starting deployment..."

            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            cd /var/www/forsa-shop

            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            echo "‚èπÔ∏è Stopping application..."
            pm2 stop forsa-shop || true

            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ git
            echo "üì• Updating code from git..."
            git fetch --all
            git reset --hard origin/main
            git pull origin main

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–æ–±–∏—Ä–∞–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
            echo "üì¶ Installing frontend dependencies..."
            npm install

            echo "üî® Building frontend..."
            npm run build

            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Å–µ—Ä–≤–µ—Ä–Ω—É—é —á–∞—Å—Ç—å
            echo "üì¶ Installing server dependencies..."
            cd server
            npm install

            echo "üî® Building server..."
            npm run build

            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –∫–æ—Ä–µ–Ω—å
            cd ..

            # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            echo "‚ñ∂Ô∏è Starting application..."
            pm2 start ecosystem.config.cjs --env production || pm2 restart forsa-shop

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo "‚úÖ Checking application status..."
            pm2 status

            # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º nginx –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏–∫–∏
            echo "üåê Reloading nginx..."
            sudo systemctl reload nginx

            echo "üéâ Deployment completed successfully!"
            echo "üåê Site: https://forsa-potolki.ru"

            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏
            echo "üìã Recent logs:"
            pm2 logs forsa-shop --lines 5 --nostream
